timedatectl set-ntp true

wipefs -a -f /dev/sda

# Partition the disk with parted
parted /dev/sda mklabel gpt
parted /dev/sda mkpart primary 1MiB 513MiB
parted /dev/sda set 1 esp on
parted /dev/sda mkpart primary 513MiB 100%

# Format the partitions
mkfs.fat -F32 /dev/sda1
mkfs.btrfs /dev/sda2

# Mount the root partition
mount /dev/sda2 /mnt

# Create subvolumes
btrfs subvolume create /mnt/root
btrfs subvolume create /mnt/home
btrfs subvolume create /mnt/snapshots

# Unmount the root partition
umount /mnt

# Mount the root subvolume
mount -o noatime,compress=zstd,subvol=root /dev/sda2 /mnt

# Create and mount the boot partition
mkdir /mnt/boot
mount /dev/sda1 /mnt/boot

# Mount the home subvolume
mkdir /mnt/home
mount -o noatime,compress=zstd,subvol=home /dev/sda2 /mnt/home

# Mount the snapshots subvolume
mkdir /mnt/.snapshots
mount -o noatime,compress=zstd,subvol=snapshots /dev/sda2 /mnt/.snapshots

pacstrap -Ki /mnt base base-devel booster gdm linux linux-firmware refind reflector sbctl zram-generator
genfstab -U /mnt >> /mnt/etc/fstab

arch-chroot /mnt <<EOF

ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime
hwclock -w -u

sed -i 's/#\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

echo rem > /etc/hostname
echo "127.0.0.1 localhost
::1 localhost
127.0.1.1 arch.localdomain arch" > /etc/hosts

echo "[Trigger]
Operation=Upgrade
Type=Package
Target=refind

[Action]
Description = Updating rEFInd on ESP
When=PostTransaction
Exec=/usr/bin/refind-install" > /etc/pacman.d/hooks/refind.hook

passwd
useradd -m -G wheel red
passwd red

systemctl enable bluetooth cups.socket gdm NetworkManager nftables reflector.timer systemd-timesyncd warp-svc
# systemctl enable --user pipewire-pulse.service

# pacman configuration
sed -i -E 's/^#(Color|VerbosePkgLists)$/\1/' /etc/pacman.conf
# sed -i 's/^#NoProgressBar$/ILoveCandy/' /etc/pacman.conf
sed -i 's/^#\(ParallelDownloads = \)5$/\1'$[`nproc`-1]'/' /etc/pacman.conf

git clone https://aur.archlinux.org/paru-bin.git
cd paru-bin
makepkg -si
cd ..
rm -rf paru-bin
paru -Syu cloudflare-warp-bin gdm-settings

# services
echo export EDITOR=/usr/bin/helix >> /etc/bash.bashrc
yes | warp-cli register
warp-cli set-families-mode malware
warp-cli connect

# enable Secure Boot
sbctl create-keys
sbctl enroll-keys -m
sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
# sbctl sign -s /boot/EFI/systemd/systemd-bootx64.efi
sbctl sign -s /boot/vmlinuz-linux

# configuration due to NVIDIA drivers
touch /etc/udev/rules.d/61-gdm.rules

# exit
# EOF
# umount -R /mnt
# reboot
# timedatectl zramctl systemctl status /dev/zram0 afterwards
# ROG tools
# pacman-key -r 8F654886F17D497FEFE3DB448B15A6B0E9A3FA35
# pacman-key --lsign-key 8F654886F17D497FEFE3DB448B15A6B0E9A3FA35
# grep g14 /etc/pacman.conf || echo -e '\n[g14]\nServer = https://arch.asus-linux.org' | sudo tee -a /etc/pacman.conf
# pacman -Syu --noconfirm --needed asusctl
# systemctl enable --now power-profiles-daemon
