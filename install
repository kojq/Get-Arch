#!/bin/bash
set -e

# Set disk
clear
echo WARNING: Back up data. The entire disk will be wiped.
PS3='Set disk: '
select disk in $(lsblk -do NAME -x SIZE | tac | head -n -2)
do
    if [[ -n $disk ]]; then
        break
    else
        echo Invalid selection. Try again.
    fi
done
[[ $disk =~ [0-9]$ ]] && separator=p

# Set credentials
clear
read -p 'Set account username: ' username
read -sp 'Set account password: ' password
echo
read -sp 'Set root password: ' root_password

# Set timezone
clear
PS3='Set timezone: '
select timezone in $(timedatectl list-timezones)
do
    if [[ -n $timezone ]]; then
        break
    else
        echo Invalid selection. Try again.
    fi
done

# Synchronize system clock
timedatectl set-ntp true

# Create partitions
parted -s /dev/$disk mklabel gpt
parted /dev/$disk mkpart ESP fat32 1MiB 513MiB
parted /dev/$disk set 1 esp on
parted /dev/$disk mkpart ARCH btrfs 513MiB 100%

# Format partitions
mkfs.fat -F32 /dev/$disk$separator'1'
mkfs.btrfs -f /dev/$disk$separator'2'

# Mount root partition
mount /dev/$disk$separator'2' /mnt

# Create subvolumes
btrfs su c /mnt/root
btrfs su c /mnt/home
btrfs su c /mnt/snapshots

# Unmount root partition
umount /mnt

# Mount root subvolume
mount -o noatime,compress=zstd,subvol=root /dev/$disk$separator'2' /mnt

# Mount home subvolume
mkdir /mnt/home
mount -o noatime,compress=zstd,subvol=home /dev/$disk$separator'2' /mnt/home

# Mount snapshots subvolume
mkdir /mnt/.snapshots
mount -o noatime,compress=zstd,subvol=snapshots /dev/$disk$separator'2' /mnt/.snapshots

# Mount ESP partition
mkdir /mnt/boot
mount /dev/$disk$separator'1' /mnt/boot

pacstrap -Ki /mnt $(lspci | grep -q NVIDIA && echo nvidia) amd-ucode aria2 baobab base base-devel booster bottom btrfs-progs cups eog espeak-ng evince firefox firefox-ublock-origin fprintd fwupd gdm git gnome-backgrounds gnome-calculator gnome-calendar gnome-characters gnome-clocks gnome-console gnome-control-center gnome-disk-utility gnome-font-viewer gnome-keyring gnome-logs gnome-sound-recorder gnome-system-monitor gnome-user-share gnome-weather gvfs gvfs-afc gvfs-goa gvfs-google gvfs-gphoto2 gvfs-mtp gvfs-nfs gvfs-smb helix hunspell hunspell-en_us hyphen hyphen-en ibus ibus-hangul ibus-kkc ibus-m17n ibus-table-chinese ibus-unikey imagemagick intel-media-driver intel-ucode lapce libmythes libreoffice-fresh libva-mesa-driver linux linux-firmware malcontent mesa mesa-vdpau mpv mythes-en nautilus networkmanager nftables noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra obs-studio orca pipewire pipewire-alsa pipewire-jack pipewire-pulse podman qt6-wayland reflector sbctl simple-scan skim systemd-resolvconf tectonic vulkan-intel vulkan-radeon wgcf wireguard-tools wireplumber xdg-desktop-portal-gnome xdg-user-dirs-gtk zram-generator

genfstab -U /mnt > /mnt/etc/fstab

arch-chroot /mnt /bin/sh <<EOF

ln -s /usr/share/zoneinfo/$timezone /etc/localtime
hwclock -wu

sed -i 's/#\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

echo arch > /etc/hostname
echo '127.0.0.1 localhost
::1 localhost
127.0.1.1 arch.localdomain arch' > /etc/hosts

sed -i -E 's/^#(Color|VerbosePkgLists)$/\1/' /etc/pacman.conf
sed -i 's/^#\(ParallelDownloads = \)5$/\1'$[`nproc`-1]'/' /etc/pacman.conf

echo '
export EDITOR=/usr/bin/helix' >> /etc/bash.bashrc

echo '
GTK_IM_MODULE=ibus
QT_IM_MODULE=ibus
XMODIFIERS=@im=ibus' >> /etc/environment

useradd -mG wheel $username
echo $username:$password | chpasswd
echo root:$root_password | chpasswd
echo $username 'ALL=(ALL) ALL' > /etc/sudoers.d/users

yes | wgcf register
wgcf generate
cp wgcf-profile.conf /etc/wireguard
rm -rf wgcf-account.toml wgcf-profile.conf

systemctl enable bluetooth cups.socket gdm NetworkManager nftables reflector.timer systemd-resolved systemd-timesyncd

mkdir /etc/pacman.d/hooks

echo '[Trigger]
Type = Package
Operation = Upgrade
Target = systemd

[Action]
Description = Gracefully upgrading systemd-boot...
When = PostTransaction
Exec = /usr/bin/systemctl restart systemd-boot-update' > /etc/pacman.d/hooks/95-systemd-boot.hook

mkdir -p /boot/loader/entries

echo 'title Arch Linux
linux /vmlinuz-linux
initrd /amd-ucode.img
initrd /intel-ucode.img
initrd /booster-linux.img
options root=PARTLABEL=ARCH zswap.enabled=0 rootflags=subvol=root rootfstype=btrfs rw' > /boot/loader/entries/arch.conf

bootctl install

echo '[zram0]
zram-size = ram / 2
compression-algorithm = zstd
swap-priority = 100
fs-type = swap' > /etc/systemd/zram-generator.conf
systemctl start systemd-zram-setup@zram0

sbctl create-keys
sbctl enroll-keys -m
sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
sbctl sign -s /boot/EFI/systemd/systemd-bootx64.efi
sbctl sign -s /boot/vmlinuz-linux

touch /etc/udev/rules.d/61-gdm.rules

EOF

umount -R /mnt
reboot
