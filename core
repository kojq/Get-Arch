#!/bin/sh
set -e

# Synchronize the system clock
timedatectl set-ntp true

# Create partitions
parted -s /dev/sda mklabel gpt
parted /dev/sda mkpart ESP fat32 1MiB 513MiB
parted /dev/sda set 1 esp on
parted /dev/sda mkpart ARCH btrfs 513MiB 100%

# Format partitions
mkfs.fat -F32 /dev/sda1
mkfs.btrfs -f /dev/sda2

# Mount the root partition
mount /dev/sda2 /mnt

# Create subvolumes
btrfs su c /mnt/root
btrfs su c /mnt/home
btrfs su c /mnt/snapshots

# Unmount the root partition
umount /mnt

# Mount the root subvolume
mount -o noatime,compress=zstd,subvol=root /dev/sda2 /mnt

# Mount the home subvolume
mkdir /mnt/home
mount -o noatime,compress=zstd,subvol=home /dev/sda2 /mnt/home

# Mount the snapshots subvolume
mkdir /mnt/.snapshots
mount -o noatime,compress=zstd,subvol=snapshots /dev/sda2 /mnt/.snapshots

# Mount the ESP partition
mkdir /mnt/efi
mount /dev/sda1 /mnt/efi

pacstrap -Ki /mnt amd-ucode aria2 baobab base base-devel booster bottom btrfs-progs cups distrobox eog espeak-ng evince firefox firefox-ublock-origin fprintd fwupd gdm git gnome-backgrounds gnome-calculator gnome-calendar gnome-characters gnome-clocks gnome-console gnome-control-center gnome-disk-utility gnome-font-viewer gnome-keyring gnome-logs gnome-sound-recorder gnome-system-monitor gnome-user-share gnome-weather gvfs gvfs-afc gvfs-goa gvfs-google gvfs-gphoto2 gvfs-mtp gvfs-nfs gvfs-smb helix hunspell hunspell-en_us hyphen hyphen-en imagemagick inkscape intel-media-driver intel-ucode lapce libmythes libreoffice-fresh libva-mesa-driver linux linux-firmware mesa mesa-vdpau mpv mythes-en nautilus networkmanager nftables noto-fonts noto-fonts-cjk noto-fonts-emoji noto-fonts-extra nvidia obs-studio orca pipewire pipewire-jack podman qt6-wayland refind reflector sbctl simple-scan skim tectonic vulkan-intel vulkan-radeon wireplumber xdg-desktop-portal-gnome zram-generator
genfstab -U /mnt > /mnt/etc/fstab

arch-chroot /mnt /bin/sh <<EOF

ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime
hwclock -wu

sed -i 's/#\(en_US.UTF-8 UTF-8\)/\1/' /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf

echo arch > /etc/hostname
echo "127.0.0.1 localhost
::1 localhost
127.0.1.1 arch.localdomain arch" > /etc/hosts

mkdir /etc/pacman.d/hooks/
echo "[Trigger]
Operation=Upgrade
Type=Package
Target=refind

[Action]
Description = Updating rEFInd on ESP
When=PostTransaction
Exec=/usr/bin/refind-install" > /etc/pacman.d/hooks/refind.hook

sed -i -E 's/^#(Color|VerbosePkgLists)$/\1/' /etc/pacman.conf
sed -i 's/^#\(ParallelDownloads = \)5$/\1'$[`nproc`-1]'/' /etc/pacman.conf

echo export EDITOR=/usr/bin/helix >> /etc/bash.bashrc
touch /etc/udev/rules.d/61-gdm.rules

systemctl enable bluetooth cups.socket gdm NetworkManager nftables reflector.timer systemd-timesyncd
# systemctl enable warp-svc && systemctl enable --user pipewire-pulse.service

read -s -p "Set a password for the root user: " root_password
echo "root:$root_password" | chpasswd

read -p "Enter the username for the additional user: " username
useradd -mG wheel "$username"

read -s -p "Set a password for the additional user account: " user_password
echo "$username:$user_password" | chpasswd

refind-install
EOF

umount -R /mnt
# reboot

#git clone https://aur.archlinux.org/paru-bin.git
#cd paru-bin
#makepkg -si
#cd ..
#rm -rf paru-bin
#paru -Syu cloudflare-warp-bin gdm-settings

#yes | warp-cli register
#warp-cli set-families-mode malware
#warp-cli connect

# enable Secure Boot
#sbctl create-keys
#sbctl enroll-keys -m
#sbctl sign -s /boot/EFI/BOOT/BOOTX64.EFI
# sbctl sign -s /boot/EFI/systemd/systemd-bootx64.efi
#sbctl sign -s /boot/vmlinuz-linux

# timedatectl zramctl systemctl status /dev/zram0 afterwards
# ROG tools
# pacman-key -r 8F654886F17D497FEFE3DB448B15A6B0E9A3FA35
# pacman-key --lsign-key 8F654886F17D497FEFE3DB448B15A6B0E9A3FA35
# grep g14 /etc/pacman.conf || echo -e '\n[g14]\nServer = https://arch.asus-linux.org' | sudo tee -a /etc/pacman.conf
# pacman -Syu --noconfirm --needed asusctl
# systemctl enable --now power-profiles-daemon
